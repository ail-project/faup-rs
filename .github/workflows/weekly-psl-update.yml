name: Weekly PSL Update and Patch Release

on:
  pull_request:
    branches: ["main"]
  schedule:
    # Run every Monday at 02:00 UTC
    - cron: "0 2 * * 1"
  workflow_dispatch:

jobs:
  update-and-release:
    name: Update PSL and Create Patch Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for cargo-release
          ref: main # Always checkout main

      - name: Install cargo-release
        run: cargo install cargo-release

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Check current PSL version
        id: current-psl
        run: |
          #echo "current_version=$(cargo tree -p psl | grep psl | head -1 | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "current_version=v2.1.149" >> $GITHUB_OUTPUT

      - name: Update PSL dependency
        run: cargo update -p psl

      - name: Check updated PSL version
        id: updated-psl
        run: |
          echo "updated_version=$(cargo tree -p psl | grep psl | head -1 | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Determine if PSL was updated
        id: psl-changed
        run: |
          if [ "${{ steps.current-psl.outputs.current_version }}" != "${{ steps.updated-psl.outputs.updated_version }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "PSL updated from ${{ steps.current-psl.outputs.current_version }} to ${{ steps.updated-psl.outputs.updated_version }}"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "PSL version unchanged: ${{ steps.current-psl.outputs.current_version }}"
          fi

      - name: Create patch release
        if: steps.psl-changed.outputs.changed == 'true'
        run: |
          # TODO: remove echo
          echo git commit -am "chore: upgrade psl ${{ steps.current-psl.outputs.current_version }}->${{ steps.updated-psl.outputs.updated_version }}"
          cargo release patch --no-push --no-publish --execute --no-confirm -p pyfaup-rs
          # TODO: remove echo
          echo git push
          # TODO: remove echo
          echo git push --tags
          echo "RELEASE_CREATED=true" >> $GITHUB_ENV

      - name: Summary
        run: |
          echo "=== Weekly PSL Update Summary ==="
          echo "Current PSL: ${{ steps.current-psl.outputs.current_version }}"
          echo "Updated PSL: ${{ steps.updated-psl.outputs.updated_version }}"
          echo "PSL Changed: ${{ steps.psl-changed.outputs.changed }}"
          if [ "$RELEASE_CREATED" = "true" ]; then
            echo "Release created"
            echo "Tags pushed to GitHub"
          else
            echo "No release created (PSL unchanged and force-release not set)"
          fi
